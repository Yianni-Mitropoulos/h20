Configuring Storage

========================
=== Congratulations! ===
========================

@ paragraph
Congratulations on installing QubesOS!

@ paragraph
This guide will help you configure your operating system's <strong>disk storage behaviour</strong> to best support your  overall secpride posture.

@ paragraph
Setting up disk storage behaviour is the most painful part of this whole process. If you're not someone who feels comfortable with command line interfaces, please just try to push through with all the willpower you can muster. Subsequent guides depend much less on the command line interface; you just have to get through this one.

@ paragraph
If you're ever unsure what a term means, how to perform a step, or why we're performing it, I suggest consulting with an AI chatbot.

======================================
=== Understand Qubes Storage Pools ===
======================================

@ paragraph
Qubes organizes both persistent and ephemeral storage using <em>Qubes storage pools</em>. Most Qubes storage pools are backed by something called a <em>logical volume</em>, which is itself backed by a <em>volume group</em>, which is back by a <em>physical volume</em>.

@ paragraph
The default Qubes storage pool created by the installer is called <code>vm-pool</code>, and it's backed by a logical volume that's also (rather confusingly) called <code>vm-pool</code>, which is itself backed by a volume group called <em>qubes_dom0</em>.

@ paragraph
The role of this Qubes storage pool is to support persistent storage on the main drive where QubesOS is installed. Meanwhile, the underlying logical volume is indifferent to whether storage ought to be persistent or ephemeral.

@ paragraph
Our first order of business is therefore creating a new Qubes storage pool, backed by the same logical volume, but providing ephemeral storage.

============================================
=== Check How Your Storage Is Configured ===
============================================

@ paragraph
Run the following in <code>dom0</code> to list all Qubes storage pools.

@ bash
qvm-pool -l

@ paragraph
One of the entries should be <code>vm-pool</code>. If you don't see it, your system is configured differently to mine, and you might need to adjust what you're doing accordingly.

@ paragraph
To get info about this pool, run:

@ bash
qvm-pool -i vm-pool

@ paragraph
You should see that it's backed by a 'thin_pool' called <code>vm-pool</code>, and by a 'volume_group' called <code>qubes_dom0</code>. Once again, if you see different names, your system is obviously configured differently to mine, and you might need to adjust what you're doing accordingly.

@ paragraph
The rest of the guide assumes your system and my system use the same names.

=========================================================
=== Create A Qubes Storage Pool For Ephemeral Storage ===
=========================================================

@ paragraph
The following code creates a new Qubes storage pool called <code>vm-pool-ephemeral</code> based on the same logical volume that the Qubes storage pool we were previously working with was based on, namely <code>vm-pool</code>.

@ bash
qvm-pool add vm-pool-ephemeral lvm_thin -o thin_pool=vm-pool -o volume_group=qubes_dom0

@ paragraph
To configure the new Qubes storage pool we just created for ephemeral storage, run the following command.

@ bash
qvm-pool -s vm-pool-ephemeral -o ephemeral_volatile=True

@ paragraph
Now we'll tell QubesOS that new VMs should use this for their volatile storage. To do this, run the following command.

@ bash
qubes-prefs default_pool_volatile vm-pool-ephemeral